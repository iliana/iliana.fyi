name: Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - uses: tailscale/github-action@e870a1112fcc1faeeeeea3c1b0ce544e5ad01844
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - run: brew update
      - run: git -C "$(brew --prefix)/Library/Taps/homebrew/homebrew-core" checkout bb47bb4a1c9dc5cbb300ef1299ba3de47447660a Formula/zola.rb
      - run: brew install zola

      - run: npm ci
        env:
          NODE_ENV: production
      - run: npm run build
      - run: rsync -avc public/ www-deploy@dreamweaver:/srv/iliana.fyi/
